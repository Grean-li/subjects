<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>课题八 活动管理后台</title>
		<link rel="stylesheet" href="https://www.layuicdn.com/layui/css/layui.css" media="all">
	</head>
	<body class="layui-layout-body">
		<div class="layui-layout layui-layout-admin">
			<div class="layui-header header">

			</div>

			<div class="layui-side layui-bg-black">
				<div class="layui-side-scroll">
					<!-- 左侧导航区域（可配合layui已有的垂直导航） -->
					<ul class="layui-nav layui-nav-tree" lay-filter="test">
						<li class="layui-nav-item layui-nav-itemed">
							<a class="" href="javascript:;">系统管理</a>
							<dl class="layui-nav-child">
								<dd class="layui-this"><a href="javascript:;">活动管理</a></dd>
								<dd><a href="log.html">日志管理</a></dd>
								<dd><a href="partyBranch.html">党支部管理</a></dd>
								<dd><a href="http://localhost:8089/doc.html" target="_blank">接口文档</a></dd>
							</dl>
						</li>
					</ul>
				</div>
			</div>

			<div class="layui-body">
				<div class="layui-container">
					<blockquote class="layui-elem-quote">课题八</blockquote>

					<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
					</fieldset>

					<div class="layui-row">
						<div class="layui-col-xs6">

						</div>
						<div class="layui-col-xs6">

						</div>
					</div>
					<div class="layui-row">

					</div>


					<div class="demoTable">
						所属党支部
						<div class="layui-inline">
							<input class="layui-input" name="id" id="partyBranch" autocomplete="off">
						</div>

						活动主题
						<div class="layui-inline">
							<input class="layui-input" name="id" id="activityTheme" autocomplete="off">
						</div>
						活动状态
						<div class="layui-inline">
							<div class="layui-input-inline">
								<select name="modules" id="activityStatus" class="layui-input">
									<!-- -1 已取消 0 报名已结束 1 报名中 2 进行中 3 活动已结束 4 未开始 -->
									<option value="">全部</option>
									<option value="-1">已取消</option>
									<option value="0">报名已结束</option>
									<option value="1">报名中</option>
									<option value="2">进行中</option>
									<option value="3">活动已结束</option>
									<option value="4">未开始</option>
								</select>
							</div>
						</div>
						<button class="layui-btn" data-type="reload">搜索</button>
					</div>

					<table class="layui-hide" id="LAY_table_user" lay-filter="user"></table>

				</div>
			</div>
			<!-- -1 已取消 0 报名已结束 1 报名中 2 进行中 3 活动已结束 4 未开始 -->
			<script type="text/html" id="activityStatusTemplet">
				{{#  if(d.activityStatus==-1){ }}
					
					<input type="checkbox" value="{{d.id}}" checked=""  name="open-1" lay-skin="switch" lay-filter="switchTest-1" lay-text="已取消|已取消">
					<input type="checkbox" value="{{d.id}}"  name="open0" lay-skin="switch" lay-filter="switchTest0" lay-text="报名已结束|报名已结束">
					<input type="checkbox" value="{{d.id}}" name="open1" lay-skin="switch" lay-filter="switchTest1" lay-text="报名中|报名中">
					<input type="checkbox" value="{{d.id}}"  name="open2" lay-skin="switch" lay-filter="switchTest2" lay-text="进行中|进行中">
					<input type="checkbox" value="{{d.id}}" name="open3" lay-skin="switch" lay-filter="switchTest3" lay-text="活动已结束|活动已结束">
					<input type="checkbox" value="{{d.id}}" name="open4" lay-skin="switch" lay-filter="switchTest4" lay-text="未开始|未开始">
			 {{#  } else if(d.activityStatus==0) { }}
			    <input type="checkbox" name="open-1" lay-skin="switch" lay-filter="switchTest-1" lay-text="已取消|已取消">
			    					<input type="checkbox" value="{{d.id}}" checked=""    name="open0" lay-skin="switch" lay-filter="switchTest0" lay-text="报名已结束|报名已结束">
			    					<input type="checkbox" value="{{d.id}}"  name="open1" lay-skin="switch" lay-filter="switchTest1" lay-text="报名中|报名中">
			    					<input type="checkbox" value="{{d.id}}"  name="open2" lay-skin="switch" lay-filter="switchTest2" lay-text="进行中|进行中">
			    					<input type="checkbox" value="{{d.id}}" name="open3" lay-skin="switch" lay-filter="switchTest3" lay-text="活动已结束|活动已结束">
			    					<input type="checkbox" value="{{d.id}}"  name="open4" lay-skin="switch" lay-filter="switchTest4" lay-text="未开始|未开始">
			    
				 
				 {{#  } else if(d.activityStatus==1) { }}
				    <input type="checkbox" name="open-1" lay-skin="switch" lay-filter="switchTest-1" lay-text="已取消|已取消">
				    					<input type="checkbox"  value="{{d.id}}"  name="open0" lay-skin="switch" lay-filter="switchTest0" lay-text="报名已结束|报名已结束">
				    					<input type="checkbox"  value="{{d.id}}" checked=""  name="open1" lay-skin="switch" lay-filter="switchTest1" lay-text="报名中|报名中">
				    					<input type="checkbox"  value="{{d.id}}" name="open2" lay-skin="switch" lay-filter="switchTest2" lay-text="进行中|进行中">
				    					<input type="checkbox"  value="{{d.id}}" name="open3" lay-skin="switch" lay-filter="switchTest3" lay-text="活动已结束|活动已结束">
				    					<input type="checkbox" value="{{d.id}}" name="open4" lay-skin="switch" lay-filter="switchTest4" lay-text="未开始|未开始">
				    
				     
					{{#  } else if(d.activityStatus==2) { }}
					   <input type="checkbox" name="open-1" lay-skin="switch" lay-filter="switchTest-1" lay-text="已取消|已取消">
					   					<input type="checkbox"  value="{{d.id}}"  name="open0" lay-skin="switch" lay-filter="switchTest0" lay-text="报名已结束|报名已结束">
					   					<input type="checkbox" value="{{d.id}}"  name="open1" lay-skin="switch" lay-filter="switchTest1" lay-text="报名中|报名中">
					   					<input type="checkbox" value="{{d.id}}"  checked=""  name="open2" lay-skin="switch" lay-filter="switchTest2" lay-text="进行中|进行中">
					   					<input type="checkbox"  value="{{d.id}}" name="open3" lay-skin="switch" lay-filter="switchTest3" lay-text="活动已结束|活动已结束">
					   					<input type="checkbox"  value="{{d.id}}" name="open4" lay-skin="switch" lay-filter="switchTest4" lay-text="未开始|未开始">
					   
					   {{#  } else if(d.activityStatus==3) { }}
					      <input type="checkbox" name="open-1" lay-skin="switch" lay-filter="switchTest-1" lay-text="已取消|已取消">
					      					<input type="checkbox" value="{{d.id}}"   name="open0" lay-skin="switch" lay-filter="switchTest0" lay-text="报名已结束|报名已结束">
					      					<input type="checkbox" value="{{d.id}}"  name="open1" lay-skin="switch" lay-filter="switchTest1" lay-text="报名中|报名中">
					      					<input type="checkbox" value="{{d.id}}" name="open2" lay-skin="switch" lay-filter="switchTest2" lay-text="进行中|进行中">
					      					<input type="checkbox"  value="{{d.id}}" checked=""  name="open3" lay-skin="switch" lay-filter="switchTest3" lay-text="活动已结束|活动已结束">
					      					<input type="checkbox"  value="{{d.id}}" name="open4" lay-skin="switch" lay-filter="switchTest4" lay-text="未开始|未开始">
					      
						  {{#  } else if(d.activityStatus==4) { }}
						    <input type="checkbox" name="open-1" lay-skin="switch" lay-filter="switchTest-1" lay-text="已取消|已取消">
						    					<input type="checkbox" value="{{d.id}}"   name="open0" lay-skin="switch" lay-filter="switchTes0t" lay-text="报名已结束|报名已结束">
						    					<input type="checkbox" value="{{d.id}}"  name="open1" lay-skin="switch" lay-filter="switchTest1" lay-text="报名中|报名中">
						    					<input type="checkbox" value="{{d.id}}" name="open2" lay-skin="switch" lay-filter="switchTest2" lay-text="进行中|进行中">
						    					<input type="checkbox" value="{{d.id}}"  name="open3" lay-skin="switch" lay-filter="switchTest3" lay-text="活动已结束|活动已结束">
						    					<input type="checkbox" value="{{d.id}}" checked="" name="open4" lay-skin="switch" lay-filter="switchTest4" lay-text="未开始|未开始">
						    
			  {{#  } else { }}
				 
			  {{#  } }}
			  
			</script>
			<script type="text/html" id="barDemo">
				<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看报名</a>
				<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="comment">查看评论</a>
				<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">取消</a>
			</script>
			<script type="text/html" id="toolbarDemo">
				<div class="layui-btn-container">
					<button class="layui-btn layui-btn-sm" lay-event="add">添加</button>
					<button class="layui-btn layui-btn-sm" lay-event="update">编辑</button>
				</div>
			</script>
			<div class="layui-footer">
				<!-- 底部固定区域 -->
				© wonder4work.com
			</div>
		</div>
		<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
		<script src="https://www.layuicdn.com/layui/layui.js" charset="utf-8"></script>
		<script src="https://cdn.staticfile.org/axios/0.18.0/axios.min.js"></script>
		<script src="app.js"></script>
		<script>
			$(function() {
				$(".header").load("header.html");
			});

			layui.use(['form','laydate', 'laypage', 'layer', 'table', 'element'], function() {
				var laydate = layui.laydate //日期
					,
					laypage = layui.laypage //分页
					,
					layer = layui.layer //弹层
					,
					table = layui.table //表格
					,
					element = layui.element //元素操作
					,
					laydate = layui.laydate,
					form = layui.form

				//日期范围
				laydate.render({
					elem: '#createTimeMin',
					value: '2020-09-04',
					isInitValue: true
				});

				laydate.render({
					elem: '#createTimeMax',
					value: '2020-09-04',
					isInitValue: true
				});
				
				//监听指定开关
				form.on('switch(switchTest-1)', function(data) {
					if(this.checked){
						axios.get(window.app.serverUrl + 'activity/changeStatus?activityId=' + data.value+'&activityStatus=-1').then(function(result) {
						
							if (result.data.status == 200) {
						
								layer.msg('取消成功');
								table.reload('testReload', {
						
								}, 'data');
							} else {
								layer.msg(result.data.msg);
							}
						form.render()
						})
						
						
					}else{
						layer.msg('请选择一种状态');
					}
				});


//监听指定开关
				form.on('switch(switchTest0)', function(data) {
					if(this.checked){
						axios.get(window.app.serverUrl + 'activity/changeStatus?activityId=' + data.value+'&activityStatus=0').then(function(result) {
						
							if (result.data.status == 200) {
						
								layer.msg('成功');
								table.reload('testReload', {
						
								}, 'data');
							} else {
								layer.msg(result.data.msg);
							}
						form.render()
						})
						
						
					}else{
						layer.msg('请选择一种状态');
					}
				});
				
				//监听指定开关
				form.on('switch(switchTest1)', function(data) {
					if(this.checked){
						axios.get(window.app.serverUrl + 'activity/changeStatus?activityId=' + data.value+'&activityStatus=1').then(function(result) {
						
							if (result.data.status == 200) {
						
								layer.msg('成功');
								table.reload('testReload', {
						
								}, 'data');
							} else {
								layer.msg(result.data.msg);
							}
						
						})
						
					}else{
						layer.msg('请选择一种状态');
					}
				});
				
				//监听指定开关
				form.on('switch(switchTest2)', function(data) {
					if(this.checked){
						axios.get(window.app.serverUrl + 'activity/changeStatus?activityId=' + data.value+'&activityStatus=2').then(function(result) {
						
							if (result.data.status == 200) {
						
								layer.msg('成功');
								table.reload('testReload', {
						
								}, 'data');
							} else {
								layer.msg(result.data.msg);
							}
						form.render()
						})
						
					}else{
						layer.msg('请选择一种状态');
					}
				});
				
				//监听指定开关
				form.on('switch(switchTest3)', function(data) {
					if(this.checked){
						axios.get(window.app.serverUrl + 'activity/changeStatus?activityId=' + data.value+'&activityStatus=3').then(function(result) {
						
							if (result.data.status == 200) {
						
								layer.msg('成功');
								table.reload('testReload', {
						
								}, 'data');
							} else {
								layer.msg(result.data.msg);
							}
						form.render()
						})
						
					}else{
						layer.msg('请选择一种状态');
					}
				});
				
				//监听指定开关
				form.on('switch(switchTest4)', function(data) {
					if(this.checked){
						axios.get(window.app.serverUrl + 'activity/changeStatus?activityId=' + data.value+'&activityStatus=4').then(function(result) {
						
							if (result.data.status == 200) {
						
								layer.msg('成功');
								table.reload('testReload', {
						
								}, 'data');
							} else {
								layer.msg(result.data.msg);
							}
						form.render()
						})
						
					}else{
						layer.msg('请选择一种状态');
					}
				});

				//方法级渲染
				table.render({
					elem: '#LAY_table_user',

					url: window.app.serverUrl + 'activity/query',
					parseData: function(res) { //res 即为原始返回的数据
						// console.log(res)
						return {
							"status": res.status, //解析接口状态
							"msg": res.msg, //解析提示文本
							"page": res.data.page,
							"total": res.data.records,
							// "records": res.data.records,
							"data": res.data.rows //解析数据列表
						};
					},

					request: {
						page: 1,
						limitName: 'pageSize'
					},
					response: {
						statusName: 'status' //规定数据状态的字段名称，默认：code
							,
						statusCode: 200 //规定成功的状态码，默认：0
							,
						msgName: 'msg' //规定状态信息的字段名称，默认：msg
							,
						countName: 'total' //规定数据总数的字段名称，默认：count
							,
						dataName: 'data' //规定数据列表的字段名称，默认：data
					},
					cols: [
						[{
								checkbox: true,
								fixed: true
							}, {
								field: 'partyBranch',
								title: '所属党支部',
								width: 200,
							},
							{
								field: 'activityTheme',
								title: '活动主题',
								width: 200,
							},
							{
								field: 'signUpStartTime',
								title: '报名开始时间',
								sort: true,
								width: 200
							},
							{
								field: 'signUpEndTime',
								title: '报名结束时间',
								sort: true,
								width: 200
							}, 
							
							{
								field: 'activityStartTime',
								title: '活动开始时间',
								sort: true,
								width: 200
							},
							{
								field: 'activityEndTime',
								title: '活动结束时间',
								sort: true,
								width: 200
							},
							{
								field: 'activityStatus',
								title: '状态',
								sort: true,
								width: 550,
								templet: '#activityStatusTemplet'
							},
							{
								field: 'signUpNum',
								title: '已报名人数',
								sort: true,
								width: 200
							},
							{
								field: 'commentNum',
								title: '评论数',
								sort: true,
								width: 200
							},
							{
								field: 'likeNum',
								title: '点赞数',
								sort: true,
								width: 200
							},
							{
								fixed: 'right',
								width: 220,
								align: 'right',
								toolbar: '#barDemo'
							}
						]
					],
					id: 'testReload',
					page: true,
					toolbar: '#toolbarDemo',
					height: 500
				});


				// 弹出窗口
				function pop(title, content) {
					var that = this;
					//多窗口模式，层叠置顶
					layer.open({
						type: 2 //此处以iframe举例
							,
						title: title,
						area: ['990px', '750px'],
						shade: 0,
						maxmin: true,
						// offset: [ //为了演示，随机坐标
						// 	Math.random() * ($(window).height() - 300), Math.random() * ($(window).width() - 390)
						// ],
						content: content,
						zIndex: layer.zIndex //重点1
							,
						success: function(layero) {
							layer.setTop(layero); //重点2
						},
						end: function(index, layero) {

							table.reload('testReload', {
								url: window.app.serverUrl + 'activity/query',
								page: {
									page: 1 //重新从第 1 页开始
								}
							}, 'data');

							// return false; 
						}
					});
				}

				var $ = layui.$,
					active = {
						reload: function() {
							// partyBranch  activityTheme  activityStatus
							var partyBranch = $('#partyBranch').val();
							var activityTheme = $('#activityTheme').val();
							var activityStatus = $('#activityStatus').val();
							//执行重载
							table.reload('testReload', {
								url: window.app.serverUrl + 'activity/query',
								page: {
									page: 1 //重新从第 1 页开始
								},
								where: {
									partyBranch: partyBranch,
									activityTheme: activityTheme,
									activityStatus: activityStatus
								}
							}, 'data');
						}
					};

				//监听头工具栏事件
				table.on('toolbar(user)', function(obj) {
					var checkStatus = table.checkStatus(obj.config.id),
						data = checkStatus.data; //获取选中的数据
					switch (obj.event) {
						case 'add':
							// layer.msg('您不是管理员，无法执行此操作！');
							pop('新增活动', './signUpPage.html?partyBranch='+window.app.userInfo.partyBranch)
							break;
						case 'update':
							if (data.length === 0) {
								layer.msg('请选择一行');
							} else if (data.length > 1) {
								layer.msg('只能同时编辑一个');
							} else {
								pop('编辑活动', './signUpPage.html?activityId='+checkStatus.data[0].id)
								
							}
							break;

					};
				});

				//监听行工具事件
				table.on('tool(user)', function(obj) { //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
					var data = obj.data //获得当前行数据
						,
						layEvent = obj.event; //获得 lay-event 对应的值
					if (layEvent === 'detail') {
						pop(data.activityTheme, './signUpDetail.html?id=' + data.id)
					} else if (layEvent === 'del') {
						layer.confirm('确定取消活动吗？', function(index) {
							layer.close(index);
							//向服务端发送指令
							axios.post(window.app.serverUrl + 'activity/cancel/' + data.id).then(function(result) {

								if (result.data.status == 200) {

									layer.msg('取消成功');
									table.reload('testReload', {

									}, 'data');
								} else {
									layer.msg(result.data.msg);
								}

							})
						});
					}else if (layEvent === 'comment') {
						
						pop(data.activityTheme, './commentDetail.html?id=' + data.id)
					}
				});

				

				$('.demoTable .layui-btn').on('click', function() {
					var type = $(this).data('type');
					active[type] ? active[type].call(this) : '';
				});
			});
		</script>
	</body>
</html>
